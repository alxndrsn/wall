<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

	<title>Wall</title>

	<!-- Bootstrap -->
	<link href="bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="respond/1.4.2/respond.min.js"></script>
	<![endif]-->

	<style>
		td { vertical-align:top; }
		.issue .media-body { vertical-align:middle; }
		.avatar {
			width: 48px;
			height: 48px;
			border-radius: 24px;
			-webkit-border-radius: 24px;
			-moz-border-radius: 24px;
			margin: 7px;
			background: url(http://link-to-your/image.jpg) no-repeat;
			box-shadow: 0 0 8px rgba(0, 0, 0, .8);
			-webkit-box-shadow: 0 0 8px rgba(0, 0, 0, .8);
			-moz-box-shadow: 0 0 8px rgba(0, 0, 0, .8);
		}
	</style>
	<link rel="shortcut icon" href="http://www.medicmobile.org/favicon.ico" id="favicon"></link>
</head>
<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Wall for <span class="repo-name"></span></a>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<form class="navbar-form navbar-right">
					<div class="input-group">
						<div class="input-group-btn">
							<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Milestone <span class="caret"></span></button>
							<ul class="dropdown-menu milestones">
								<li><a href="#">All</a></li>
								<li role="separator" class="divider"></li>
							</ul>
						</div><!-- /btn-group -->
						<input type="text" class="form-control" aria-label="milestone" name="milestone" disabled="disabled"/>
					</div><!-- /input-group -->
				</form>
			</div><!-- /.navbar-collapse -->
		</div><!-- /.container-fluid -->
	</nav>

	<div class="panel panel-default">
		<div class="panel-body">
			<div style="display:none" class="github-api alert alert-warning" role="alert">
				Your <a href="https://api.github.com/rate_limit">github API allowance</a> is running low...</div>
			<div style="display:none" class="github-api alert alert-danger" role="alert">
				Your <a href="https://api.github.com/rate_limit">github API allowance</a> has run out!</div>
		</div>
		<div id="wall-placeholder"></div>
	</div>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="jquery/1.11.3/jquery.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="lodash-compat/3.10.1/lodash.min.js"></script>
	<script src="js/string.js"></script>
	<script src="js/sanchez.js"></script>
	<script src="js/github.js"></script>
	<script src="js/wall.js"></script>

	<script id="issue" type="text/x-sanchez-template">
		<div class="issue media">
			<div class="media-left">
				<a href="{{user.url}}">
					<img class="avatar media-object" src="{{user.avatar_url}}" alt="{{user.login}}">
				</a>
			</div>
			<div class="media-body">
				<a href="{{url}}">
					<h4 class="media-heading">{{title}}</h4>
				</a>
			</div>
		</div>
	</script>

	<script id="table" type="text/x-sanchez-template">
		<table class="table"><thead><tr/></thead><tbody><tr/></tbody></table>
	</script>

	<script id="column-header" type="text/x-sanchez-template">
		<th class="col-md-{{columns}}">
			{{heading}} <span class="badge">0</span>
		</th>
	</script>

	<script id="milestone-li" type="text/x-sanchez-template">
		<li onclick="selectMilestone({{id}}, '{{title}}')" href="#"><a href="">{{title}}</a></li>
	</script>

	<script id="repo-name-link" type="text/x-sanchez-template">
		<a class="repo-name" href="http://www.github.com/{{repo}}/issues">{{repo}}</a>
	</script>

	<script>
	function parseParams() {
		var params = {};
		if(location.search) {
			location.search.substr(1).split('&').forEach(function(p) {
				var parts = p.split('=');
				params[parts[0]] = parts[1];
			});
		}
		return params;
	}
	function selectMilestone(number, title) {
		var params = parseParams(), paramString = '?';
		params.milestone = number;
		_.forEach(params, function(val, key) {
			paramString += encodeURIComponent(key) + '=' +
					encodeURIComponent(val) + '&'; });
		$('input[name=milestone]').val(title);
		window.location = window.location.protocol + '//' +
				window.location.host +
				window.location.pathname + paramString;
	}
	$(function() {
		var params = parseParams(), repo, cols, milestone;
		if(params.favicon) $('#favicon').attr('href', params.favicon);

		repo = params.repo || 'medic/medic-webapp';
		sanchez.replace('span.repo-name', 'repo-name-link', { repo:repo });

		milestone = parseInt(params.milestone, 10);
		if(isNaN(milestone)) milestone = null;

		cols = params.cols ? JSON.parse(decodeURIComponent(params.cols)) : [
				'1 - Scheduled',
				'2 - Active Work',
				'3 - Acceptance testing',
				'4 - Ready' ];

		github.api_usage(function(usage) {
			var remaining = usage.rate.remaining;
			if(remaining < 4) {
				$('.github-api.alert-danger').show(200);
			} else if(remaining < 20) {
				$('.github-api.alert-warning').show(200);
			}
		});

		github.withMilestonesFor(repo, function(milestones) {
			var list = $('ul.milestones');
			_.forEach(milestones, function(m) {
				sanchez.append('ul.milestones', 'milestone-li',
						{ id:m.number, title:m.title });
				if(m.number === milestone) {
					$('input[name=milestone]').val(m.title);
				}
			});
		});

		new Wall('#wall-placeholder', repo, cols, milestone);
	});
	</script>
</body>
</html>
